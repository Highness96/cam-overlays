<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Tip Wheel Overlay</title>

<style>
:root{
  --panel-bg: rgba(20, 0, 35, 0.65);
  --panel-border: rgba(180, 120, 255, 0.8);
  --glow: rgba(200, 140, 255, 1);
  --text: #ffffff;
  --accent1: #b86cff;
  --accent2: #6ee7ff;
}

html, body {
  margin: 0;
  padding: 0;
  background: transparent;
  overflow: hidden;
  font-family: Arial, Helvetica, sans-serif;
  color: var(--text);
}

#wrap {
  position: absolute;
  right: 40px;
  bottom: 40px;
  width: 900px;
  height: 900px;
  pointer-events: none;
}

#panel {
  position: absolute;
  inset: 0;
  background: var(--panel-bg);
  border-radius: 28px;
  border: 3px solid var(--panel-border);
  box-shadow:
    0 0 40px rgba(180,120,255,0.35),
    0 0 80px rgba(180,120,255,0.25);
}

#header {
  position: absolute;
  top: 18px;
  left: 24px;
  right: 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

#title {
  font-size: 28px;
  font-weight: 900;
}

#cost {
  font-size: 20px;
  padding: 8px 14px;
  border-radius: 999px;
  background: rgba(0,0,0,0.4);
}

#pointer {
  position: absolute;
  top: 115px;
  left: 50%;
  transform: translateX(-50%);
  width: 0;
  height: 0;
  border-left: 28px solid transparent;
  border-right: 28px solid transparent;
  border-bottom: 44px solid var(--accent2);
  filter: drop-shadow(0 0 15px rgba(110,231,255,0.9));
}

#canvas {
  position: absolute;
  left: 50%;
  top: 56%;
  transform: translate(-50%, -50%);
  width: 720px;
  height: 720px;
}

#result {
  position: absolute;
  left: 24px;
  right: 24px;
  bottom: 24px;
  padding: 18px 20px;
  font-size: 22px;
  border-radius: 18px;
  background: rgba(0,0,0,0.45);
  display: flex;
  justify-content: space-between;
}

.flash {
  animation: flash 0.9s ease-out;
}

@keyframes flash {
  0%   { box-shadow: 0 0 0 rgba(0,0,0,0); }
  30%  { box-shadow: 0 0 120px var(--glow); }
  100% { box-shadow: 0 0 40px rgba(180,120,255,0.4); }
}
</style>
</head>

<body>

<div id="wrap">
  <div id="panel"></div>

  <div id="header">
    <div id="title">TIP WHEEL</div>
    <div id="cost">Spin: <span id="spinCost">100</span> tokens</div>
  </div>

  <div id="pointer"></div>
  <canvas id="canvas" width="720" height="720"></canvas>

  <div id="result">
    <div>Result: <b id="lastResult">—</b></div>
    <div id="lastTip" style="opacity:.75;">waiting for tip…</div>
  </div>
</div>

<!-- AUDIO -->
<audio id="soundTip"  src="audio/tip.wav" preload="auto"></audio>
<audio id="soundSpin" src="audio/spin.wav" preload="auto"></audio>
<audio id="soundWin"  src="audio/win.wav" preload="auto"></audio>

<script>
/* ================= CONFIG ================= */
const SPIN_COST = 100;
const ITEMS = [
  "Pull pants down",
  "Flash anything (5 sec)",
  "Show feet",
  "I choose",
  "Grab my package",
  "Chat chooses",
  "Spin again",
  "VIP attention"
];

document.getElementById("spinCost").textContent = SPIN_COST;

/* ================= AUDIO ================= */
const soundTip  = document.getElementById("soundTip");
const soundSpin = document.getElementById("soundSpin");
const soundWin  = document.getElementById("soundWin");

function playSound(a){
  try{
    a.pause();
    a.currentTime = 0;
    a.play().catch(()=>{});
  }catch(e){}
}

/* ================= WHEEL ================= */
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const panel = document.getElementById("panel");
const lastResult = document.getElementById("lastResult");
const lastTip = document.getElementById("lastTip");

let angle = 0;
let spinning = false;
let angularVelocity = 0;

const FRICTION = 0.988;      // slower = longer spin
const MIN_VELOCITY = 0.002; // stop threshold

function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
  const words = text.split(" ");
  let line = "";
  let offsetY = y;

  for (let w of words) {
    const test = line + w + " ";
    if (ctx.measureText(test).width > maxWidth) {
      ctx.fillText(line, x, offsetY);
      line = w + " ";
      offsetY += lineHeight;
    } else line = test;
  }
  ctx.fillText(line, x, offsetY);
}

function drawWheel(){
  const cx = 360, cy = 360, r = 330;
  const slice = Math.PI * 2 / ITEMS.length;

  ctx.clearRect(0,0,720,720);

  ITEMS.forEach((text,i)=>{
    const start = angle + i * slice;
    const end = start + slice;

    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,r,start,end);
    ctx.fillStyle = i%2 ? "rgba(110,231,255,.35)" : "rgba(184,108,255,.45)";
    ctx.fill();
    ctx.strokeStyle="rgba(255,255,255,.35)";
    ctx.stroke();

    ctx.save();
    ctx.translate(cx,cy);
    ctx.rotate(start + slice/2);
    ctx.textAlign="right";
    ctx.textBaseline="middle";
    ctx.font="700 16px Arial";
    ctx.fillStyle="#fff";
    ctx.shadowBlur=8;
    wrapText(ctx,text,r-36,0,150,18);
    ctx.restore();
  });

  ctx.beginPath();
  ctx.arc(cx,cy,70,0,Math.PI*2);
  ctx.fillStyle="rgba(0,0,0,.6)";
  ctx.fill();
  ctx.strokeStyle="#fff";
  ctx.stroke();

  ctx.fillStyle="#fff";
  ctx.font="900 22px Arial";
  ctx.textAlign="center";
  ctx.textBaseline="middle";
  ctx.fillText("SPIN",cx,cy);
}

drawWheel();

/* ================= SPIN LOGIC ================= */
function spin(user, amount){
  if(spinning) return;
  spinning = true;

  playSound(soundSpin);
  panel.classList.remove("flash");
  void panel.offsetWidth;
  panel.classList.add("flash");

  lastTip.textContent = `Tip ${amount} by ${user}`;

  angularVelocity =
    (Math.random()*0.35 + 0.45) *
    (Math.random()<0.5 ? -1 : 1);

  function frame(){
    angle += angularVelocity;
    angularVelocity *= FRICTION;
    drawWheel();

    if(Math.abs(angularVelocity) > MIN_VELOCITY){
      requestAnimationFrame(frame);
    } else {
      const slice = Math.PI*2 / ITEMS.length;
      const index = Math.floor(
        ((Math.PI*1.5 - angle + Math.PI*2)%(Math.PI*2)) / slice
      );
      lastResult.textContent = ITEMS[index];
      playSound(soundWin);
      spinning = false;
    }
  }
  requestAnimationFrame(frame);
}

/* ================= TIP HANDLING ================= */
function handleTip(data){
  if(!data || data.type!=="tip") return;
  playSound(soundTip);
  if(data.amount >= SPIN_COST){
    spin(data.user||"anon", data.amount);
  }
}

window.addEventListener("message", e => handleTip(e.data));

try{
  const bc = new BroadcastChannel("cb-overlays");
  bc.onmessage = e => handleTip(e.data);
}catch(e){}
</script>

</body>
</html>
