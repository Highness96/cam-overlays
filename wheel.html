<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tip Wheel</title>
  <style>
    :root{
      --bg: rgba(0,0,0,0);
      --panel: rgba(18, 0, 28, 0.55);
      --stroke: rgba(160, 90, 255, 0.55);
      --glow: rgba(190, 120, 255, 0.95);
      --text: #ffffff;
      --muted: rgba(255,255,255,0.75);
      --accent: #a95cff;
      --accent2:#5ee7ff;
      --shadow: rgba(0,0,0,0.65);
    }

    html, body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      overflow: hidden;
      font-family: Arial, Helvetica, sans-serif;
      color: var(--text);
    }

    /* Position this anywhere */
    #wrap {
      position: absolute;
      right: 24px;
      bottom: 24px;
      width: 520px;
      height: 520px;
      pointer-events: none;
    }

    #panel {
      position: absolute;
      inset: 0;
      background: radial-gradient(120% 120% at 30% 20%, rgba(169,92,255,0.25), rgba(0,0,0,0)) , var(--panel);
      border: 2px solid var(--stroke);
      border-radius: 22px;
      box-shadow:
        0 20px 60px var(--shadow),
        0 0 30px rgba(169,92,255,0.25);
      backdrop-filter: blur(6px);
    }

    #header {
      position: absolute;
      top: 14px;
      left: 16px;
      right: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      pointer-events: none;
    }

    #title {
      font-weight: 800;
      letter-spacing: 0.5px;
      font-size: 18px;
      text-shadow: 0 2px 10px rgba(0,0,0,0.7);
    }

    #cost {
      font-size: 14px;
      color: var(--muted);
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.22);
    }

    #canvas {
      position: absolute;
      left: 50%;
      top: 56%;
      transform: translate(-50%, -50%);
      width: 430px;
      height: 430px;
      filter: drop-shadow(0 14px 25px rgba(0,0,0,0.55));
    }

    #pointer {
      position: absolute;
      left: 50%;
      top: 66px;
      transform: translateX(-50%);
      width: 0; height: 0;
      border-left: 16px solid transparent;
      border-right: 16px solid transparent;
      border-bottom: 26px solid var(--accent2);
      filter: drop-shadow(0 6px 10px rgba(0,0,0,0.7));
    }

    #result {
      position: absolute;
      left: 18px;
      right: 18px;
      bottom: 16px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.25);
      box-shadow: 0 10px 20px rgba(0,0,0,0.35);
      font-size: 16px;
      line-height: 1.2;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    #result b { font-weight: 800; }

    .flash {
      animation: flash 900ms ease-out 1;
    }
    @keyframes flash {
      0%   { box-shadow: 0 20px 60px var(--shadow), 0 0 0 rgba(0,0,0,0); }
      25%  { box-shadow: 0 20px 60px var(--shadow), 0 0 40px var(--glow); }
      60%  { box-shadow: 0 20px 60px var(--shadow), 0 0 22px rgba(190,120,255,0.55); }
      100% { box-shadow: 0 20px 60px var(--shadow), 0 0 30px rgba(169,92,255,0.25); }
    }
  </style>
</head>
<body>
  <div id="wrap">
    <div id="panel"></div>

    <div id="header">
      <div id="title">Tip Wheel</div>
      <div id="cost">Spin: <span id="spinCostText">100</span> tokens</div>
    </div>

    <div id="pointer"></div>
    <canvas id="canvas" width="430" height="430"></canvas>

    <div id="result">
      <div>Last spin: <b id="lastResult">—</b></div>
      <div style="color:rgba(255,255,255,0.7);font-size:13px" id="lastTip">waiting…</div>
    </div>
  </div>

  <script>
    // ====== SETTINGS ======
    const SPIN_COST = 100;                 // tokens required to trigger a spin
    const ALLOW_MULTIPLE_SPINS = true;     // if someone tips 200 and cost=100 => 2 spins

    // Edit these however you want (keep them non-explicit to stay safe)
    const ITEMS = [
      "Slow pose (5 sec)",
      "Blow a kiss",
      "Dance (10 sec)",
      "Say something teasing",
      "Spin again (free)",
      "Pick the next vibe/song"
    ];

    // ====== STATE ======
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const lastResultEl = document.getElementById("lastResult");
    const lastTipEl = document.getElementById("lastTip");
    const spinCostTextEl = document.getElementById("spinCostText");
    const panelEl = document.getElementById("panel");

    spinCostTextEl.textContent = String(SPIN_COST);

    let angle = 0;
    let spinning = false;

    function drawWheel() {
      const w = canvas.width;
      const h = canvas.height;
      const cx = w / 2;
      const cy = h / 2;
      const radius = 205;

      ctx.clearRect(0, 0, w, h);

      // Outer ring
      ctx.beginPath();
      ctx.arc(cx, cy, radius + 10, 0, Math.PI * 2);
      ctx.fillStyle = "rgba(0,0,0,0.25)";
      ctx.fill();
      ctx.strokeStyle = "rgba(94,231,255,0.5)";
      ctx.lineWidth = 3;
      ctx.stroke();

      const n = ITEMS.length;
      const slice = (Math.PI * 2) / n;

      // Slices
      for (let i = 0; i < n; i++) {
        const start = angle + i * slice;
        const end = start + slice;

        // alternating neon purples
        const isEven = i % 2 === 0;
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.arc(cx, cy, radius, start, end);
        ctx.closePath();
        ctx.fillStyle = isEven ? "rgba(169,92,255,0.35)" : "rgba(94,231,255,0.22)";
        ctx.fill();

        ctx.strokeStyle = "rgba(255,255,255,0.20)";
        ctx.lineWidth = 2;
        ctx.stroke();

        // Text
        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(start + slice / 2);

        ctx.textAlign = "right";
        ctx.fillStyle = "#fff";
        ctx.font = "700 15px Arial";
        ctx.shadowColor = "rgba(0,0,0,0.7)";
        ctx.shadowBlur = 10;
        ctx.fillText(ITEMS[i], radius - 16, 6);
        ctx.restore();
      }

      // Center cap
      ctx.beginPath();
      ctx.arc(cx, cy, 46, 0, Math.PI * 2);
      ctx.fillStyle = "rgba(0,0,0,0.35)";
      ctx.fill();
      ctx.strokeStyle = "rgba(190,120,255,0.75)";
      ctx.lineWidth = 3;
      ctx.stroke();

      ctx.fillStyle = "#fff";
      ctx.font = "800 14px Arial";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.shadowBlur = 0;
      ctx.fillText("SPIN", cx, cy);
    }

    function pickWinner(finalAngle) {
      const n = ITEMS.length;
      const slice = (Math.PI * 2) / n;

      // Pointer is at top (270°). Convert.
      const pointerAngle = (Math.PI * 1.5);
      const normalized = (pointerAngle - finalAngle) % (Math.PI * 2);
      const a = (normalized + Math.PI * 2) % (Math.PI * 2);

      const index = Math.floor(a / slice) % n;
      return ITEMS[index];
    }

    function flashPanel() {
      panelEl.classList.remove("flash");
      // restart animation
      void panelEl.offsetWidth;
      panelEl.classList.add("flash");
    }

    async function spinOnce(user, amount) {
      if (spinning) return;
      spinning = true;

      flashPanel();
      lastTipEl.textContent = user ? `tip: ${amount} by ${user}` : `tip: ${amount}`;

      const spins = 6 + Math.random() * 3; // 6-9 rotations
      const extra = Math.random() * Math.PI * 2;
      const startAngle = angle;
      const endAngle = startAngle + spins * Math.PI * 2 + extra;

      const duration = 4800; // ms
      const start = performance.now();

      function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }

      return new Promise((resolve) => {
        function frame(now) {
          const t = Math.min(1, (now - start) / duration);
          const e = easeOutCubic(t);
          angle = startAngle + (endAngle - startAngle) * e;
          drawWheel();

          if (t < 1) {
            requestAnimationFrame(frame);
          } else {
            const winner = pickWinner(angle);
            lastResultEl.textContent = winner;
            spinning = false;
            resolve(winner);
          }
        }
        requestAnimationFrame(frame);
      });
    }

    // Initial draw
    drawWheel();

    // Listen for DevPortal overlay messages ($overlay.send)
    window.addEventListener("message", async (event) => {
      const data = event.data || {};
      if (data.type !== "tip") return;

      const amount = Number(data.amount) || 0;
      const user = data.user || "";

      if (amount < SPIN_COST) {
        lastTipEl.textContent = user ? `tip ${amount} by ${user} (need ${SPIN_COST})` : `tip ${amount} (need ${SPIN_COST})`;
        return;
      }

      const spinsToDo = ALLOW_MULTIPLE_SPINS ? Math.floor(amount / SPIN_COST) : 1;

      for (let i = 0; i < spinsToDo; i++) {
        await spinOnce(user, amount);
        // small pause between multiple spins
        if (i < spinsToDo - 1) await new Promise(r => setTimeout(r, 600));
      }
    });
  </script>
</body>
</html>
