<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Tip Wheel Overlay</title>
<style>
  :root{
    --purple:#6a00ff;
    --purple2:#b37bff;
    --bg: rgba(10,10,10,0.35);
    --text:#ffffff;
    --shadow: rgba(0,0,0,0.8);
  }

  html, body {
    margin: 0;
    padding: 0;
    background: transparent;
    overflow: hidden;
    font-family: Arial, sans-serif;
    color: var(--text);
  }

  /* POSITION: bottom-right (adjust if you want) */
  #wrap {
    position: absolute;
    right: 20px;
    bottom: 20px;
    width: 360px;
    height: 360px;
    pointer-events: none;
  }

  #panel {
    position: absolute;
    inset: 0;
    background: var(--bg);
    border: 2px solid rgba(106,0,255,0.45);
    border-radius: 16px;
    backdrop-filter: blur(2px);
    box-shadow: 0 12px 30px rgba(0,0,0,0.35);
  }

  #title {
    position: absolute;
    top: 12px;
    left: 12px;
    right: 12px;
    text-align: center;
    font-weight: 900;
    letter-spacing: 0.8px;
    color: var(--purple2);
    text-shadow: 0 0 14px rgba(106,0,255,0.35);
    font-size: 18px;
  }

  #sub {
    position: absolute;
    top: 34px;
    left: 12px;
    right: 12px;
    text-align: center;
    font-size: 13px;
    opacity: 0.95;
    text-shadow: 2px 2px 6px var(--shadow);
  }

  canvas {
    position: absolute;
    left: 50%;
    top: 60px;
    transform: translateX(-50%);
  }

  /* Pointer */
  #pointer {
    position: absolute;
    top: 56px;
    left: 50%;
    transform: translateX(-50%);
    width: 0; height: 0;
    border-left: 14px solid transparent;
    border-right: 14px solid transparent;
    border-top: 22px solid #ffffff;
    filter: drop-shadow(0 0 10px rgba(106,0,255,0.35));
  }

  /* Result bar */
  #result {
    position: absolute;
    left: 12px;
    right: 12px;
    bottom: 12px;
    background: rgba(0,0,0,0.35);
    border: 1px solid rgba(255,255,255,0.10);
    border-radius: 12px;
    padding: 10px 12px;
    text-shadow: 2px 2px 6px var(--shadow);
    font-size: 14px;
    line-height: 1.25;
    min-height: 44px;
  }

  #result strong{
    color: #fff;
  }

  /* Glow flash on win */
  @keyframes winFlash {
    0% { box-shadow: 0 0 0 rgba(106,0,255,0); }
    35%{ box-shadow: 0 0 22px rgba(106,0,255,0.35); }
    100%{ box-shadow: 0 0 0 rgba(106,0,255,0); }
  }
  .flash {
    animation: winFlash 900ms ease-out;
  }
</style>
</head>
<body>
  <div id="wrap">
    <div id="panel"></div>
    <div id="title">TIP WHEEL</div>
    <div id="sub">Tip <span id="spinCostText">50</span>+ tokens to spin</div>
    <div id="pointer"></div>
    <canvas id="wheel" width="280" height="280"></canvas>
    <div id="result">Waiting for tips…</div>
  </div>

<script>
  // ========= SETTINGS =========
  const SPIN_COST = 50; // tokens per spin
  const SEGMENTS = [
  "Pull pants down (brief tease)",
  "Flash anything (5 seconds)",
  "Show feet",
  "I choose",
  "Grab my package",
  "Chat chooses next move",
  "Spin Again",
  "VIP attention moment"
];

  // ============================

  document.getElementById("spinCostText").textContent = SPIN_COST;

  const canvas = document.getElementById("wheel");
  const ctx = canvas.getContext("2d");
  const resultEl = document.getElementById("result");
  const wrap = document.getElementById("wrap");

  const cx = canvas.width / 2;
  const cy = canvas.height / 2;
  const radius = 125;

  let angle = 0;
  let spinning = false;
  let spinQueue = 0;
  let lastTipper = "anon";

  function drawWheel() {
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // Outer glow ring
    ctx.beginPath();
    ctx.arc(cx, cy, radius + 10, 0, Math.PI * 2);
    ctx.strokeStyle = "rgba(106,0,255,0.45)";
    ctx.lineWidth = 6;
    ctx.stroke();

    // Segments
    const n = SEGMENTS.length;
    const step = (Math.PI * 2) / n;

    for (let i = 0; i < n; i++) {
      const start = angle + i * step;
      const end = start + step;

      // alternating colors
      const base = (i % 2 === 0) ? "rgba(106,0,255,0.55)" : "rgba(179,123,255,0.40)";
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.arc(cx, cy, radius, start, end);
      ctx.closePath();
      ctx.fillStyle = base;
      ctx.fill();

      // divider
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.arc(cx, cy, radius, start, end);
      ctx.strokeStyle = "rgba(255,255,255,0.12)";
      ctx.lineWidth = 2;
      ctx.stroke();

      // label
      ctx.save();
      ctx.translate(cx, cy);
      ctx.rotate(start + step / 2);
      ctx.textAlign = "right";
      ctx.fillStyle = "#fff";
      ctx.font = "bold 14px Arial";
      ctx.shadowColor = "rgba(0,0,0,0.65)";
      ctx.shadowBlur = 6;
      ctx.fillText(SEGMENTS[i], radius - 10, 6);
      ctx.restore();
    }

    // center cap
    ctx.beginPath();
    ctx.arc(cx, cy, 24, 0, Math.PI * 2);
    ctx.fillStyle = "rgba(0,0,0,0.35)";
    ctx.fill();
    ctx.strokeStyle = "rgba(255,255,255,0.18)";
    ctx.lineWidth = 2;
    ctx.stroke();

    ctx.fillStyle = "#fff";
    ctx.font = "900 12px Arial";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("SPIN", cx, cy);
  }

  function pickWinner() {
    const n = SEGMENTS.length;
    const step = (Math.PI * 2) / n;

    // pointer is at the top (12 o'clock). Convert angle to index.
    // The pointer corresponds to angle = -pi/2 in canvas space.
    let a = (-(Math.PI / 2) - angle) % (Math.PI * 2);
    if (a < 0) a += Math.PI * 2;
    const idx = Math.floor(a / step) % n;
    return { idx, text: SEGMENTS[idx] };
  }

  function flash() {
    wrap.classList.remove("flash");
    void wrap.offsetWidth;
    wrap.classList.add("flash");
  }

  function spinOnce() {
    if (spinning) return;
    spinning = true;

    // Random spin: multiple rotations + random offset
    const extraTurns = 4 + Math.random() * 3; // 4–7 turns
    const randomOffset = Math.random() * Math.PI * 2;
    const startAngle = angle;
    const endAngle = startAngle + extraTurns * Math.PI * 2 + randomOffset;

    const duration = 2600 + Math.random() * 700;
    const startTime = performance.now();

    function easeOutCubic(t){ return 1 - Math.pow(1 - t, 3); }

    function animate(now) {
      const t = Math.min(1, (now - startTime) / duration);
      const eased = easeOutCubic(t);
      angle = startAngle + (endAngle - startAngle) * eased;

      drawWheel();

      if (t < 1) {
        requestAnimationFrame(animate);
      } else {
        spinning = false;
        const win = pickWinner();
        resultEl.innerHTML = `<strong>${lastTipper}</strong> won: <strong>${win.text}</strong>`;
        flash();

        // If the wheel landed on "Spin Again", add 1 extra spin
        if (win.text.toLowerCase().includes("spin again")) {
          spinQueue += 1;
        }

        // Run next queued spin if any
        if (spinQueue > 0) {
          spinQueue -= 1;
          setTimeout(spinOnce, 450);
        }
      }
    }

    requestAnimationFrame(animate);
  }

  function addSpinsFromTip(amount) {
    const spins = Math.floor(amount / SPIN_COST);
    if (spins <= 0) return;
    spinQueue += spins;

    // start spinning if idle
    if (!spinning) {
      spinQueue -= 1;
      spinOnce();
    }
  }

  window.addEventListener("message", (event) => {
    const data = event.data || {};
    if (data.type === "tip") {
      const amt = Number(data.amount) || 0;
      if (amt <= 0) return;

      lastTipper = (data.user || "anon").toString();
      addSpinsFromTip(amt);
    }
  });

  drawWheel();
</script>
</body>
</html>
