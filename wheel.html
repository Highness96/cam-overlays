<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Tip Wheel Overlay</title>

<style>
:root{
  --panel-bg: rgba(20, 0, 35, 0.65);
  --panel-border: rgba(180, 120, 255, 0.8);
  --glow: rgba(200, 140, 255, 1);
  --text: #ffffff;
  --accent1: #b86cff;
  --accent2: #6ee7ff;
}

html, body {
  margin: 0;
  padding: 0;
  background: transparent;
  overflow: hidden;
  font-family: Arial, Helvetica, sans-serif;
  color: var(--text);
}

/* OBS positioning */
#wrap {
  position: absolute;
  right: 40px;
  bottom: 40px;
  width: 900px;
  height: 900px;
  pointer-events: none;
}

#panel {
  position: absolute;
  inset: 0;
  background: var(--panel-bg);
  border-radius: 28px;
  border: 3px solid var(--panel-border);
  box-shadow:
    0 0 40px rgba(180,120,255,0.35),
    0 0 80px rgba(180,120,255,0.25);
}

/* Header */
#header {
  position: absolute;
  top: 18px;
  left: 24px;
  right: 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

#title {
  font-size: 28px;
  font-weight: 900;
  letter-spacing: 1px;
}

#cost {
  font-size: 20px;
  padding: 8px 14px;
  border-radius: 999px;
  background: rgba(0,0,0,0.4);
  border: 2px solid rgba(255,255,255,0.3);
}

/* Pointer */
#pointer {
  position: absolute;
  top: 115px;
  left: 50%;
  transform: translateX(-50%);
  width: 0;
  height: 0;
  border-left: 28px solid transparent;
  border-right: 28px solid transparent;
  border-bottom: 44px solid var(--accent2);
  filter: drop-shadow(0 0 15px rgba(110,231,255,0.9));
}

/* Canvas */
#canvas {
  position: absolute;
  left: 50%;
  top: 56%;
  transform: translate(-50%, -50%);
  width: 720px;
  height: 720px;
}

/* Result bar */
#result {
  position: absolute;
  left: 24px;
  right: 24px;
  bottom: 24px;
  padding: 18px 20px;
  font-size: 22px;
  border-radius: 18px;
  background: rgba(0,0,0,0.45);
  border: 2px solid rgba(255,255,255,0.25);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

#result b {
  font-size: 24px;
}

.flash {
  animation: flash 0.9s ease-out;
}

@keyframes flash {
  0%   { box-shadow: 0 0 0 rgba(0,0,0,0); }
  30%  { box-shadow: 0 0 120px var(--glow); }
  100% { box-shadow: 0 0 40px rgba(180,120,255,0.4); }
}
</style>
</head>

<body>

<div id="wrap">
  <div id="panel"></div>

  <div id="header">
    <div id="title">TIP WHEEL</div>
    <div id="cost">Spin: <span id="spinCost">100</span> tokens</div>
  </div>

  <div id="pointer"></div>
  <canvas id="canvas" width="720" height="720"></canvas>

  <div id="result">
    <div>Result: <b id="lastResult">—</b></div>
    <div id="lastTip" style="opacity:.75;">waiting for tip…</div>
  </div>
</div>

<!-- AUDIO -->
<audio id="soundTip"  src="audio/tip.wav"  preload="auto"></audio>
<audio id="soundSpin" src="audio/spin.wav" preload="auto"></audio>
<audio id="soundWin"  src="audio/win.wav"  preload="auto"></audio>

<script>
/* ================= CONFIG ================= */
const SPIN_COST = 100;
const ITEMS = [
  "Pull pants down",
  "Flash anything (5 sec)",
  "Show feet",
  "I choose",
  "Grab my package",
  "Chat chooses",
  "Spin again",
  "VIP attention"
];

/* ================= ELEMENTS ================= */
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const panel = document.getElementById("panel");
const lastResult = document.getElementById("lastResult");
const lastTip = document.getElementById("lastTip");
document.getElementById("spinCost").textContent = SPIN_COST;

/* ================= AUDIO ================= */
const soundTip  = document.getElementById("soundTip");
const soundSpin = document.getElementById("soundSpin");
const soundWin  = document.getElementById("soundWin");

soundTip.volume  = 0.7;
soundSpin.volume = 0.7;
soundWin.volume  = 0.8;

function playSound(a){
  if(!a) return;
  try{
    a.pause();
    a.currentTime = 0;
    const p = a.play();
    if (p && p.catch) p.catch(()=>{});
  }catch(e){}
}

// unlock audio for OBS/browser
function unlockAudio(){
  [soundTip, soundSpin, soundWin].forEach(a=>{
    if(!a) return;
    a.muted = true;
    const p = a.play();
    if (p && p.catch) p.catch(()=>{});
    a.pause();
    a.currentTime = 0;
    a.muted = false;
  });
  window.removeEventListener("pointerdown", unlockAudio);
  window.removeEventListener("keydown", unlockAudio);
}
window.addEventListener("pointerdown", unlockAudio);
window.addEventListener("keydown", unlockAudio);

/* ================= WHEEL ================= */
let angle = 0;
let spinning = false;

function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
  const words = text.split(" ");
  let line = "";
  let offsetY = y;

  for (let i = 0; i < words.length; i++) {
    const testLine = line + words[i] + " ";
    if (ctx.measureText(testLine).width > maxWidth && i > 0) {
      ctx.fillText(line.trim(), x, offsetY);
      line = words[i] + " ";
      offsetY += lineHeight;
    } else {
      line = testLine;
    }
  }
  ctx.fillText(line.trim(), x, offsetY);
}

function drawWheel() {
  const cx = canvas.width / 2;
  const cy = canvas.height / 2;
  const r = 330;
  const slice = (Math.PI * 2) / ITEMS.length;

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // slices
  ITEMS.forEach((text, i) => {
    const start = angle + i * slice;
    const end = start + slice;

    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, r, start, end);
    ctx.fillStyle = i % 2 ? "rgba(110,231,255,0.35)" : "rgba(184,108,255,0.45)";
    ctx.fill();

    ctx.strokeStyle = "rgba(255,255,255,0.35)";
    ctx.lineWidth = 3;
    ctx.stroke();

    ctx.save();
    ctx.translate(cx, cy);
    ctx.rotate(start + slice / 2);
    ctx.textAlign = "right";
    ctx.textBaseline = "middle";
    ctx.font = "700 16px Arial";
    ctx.fillStyle = "#fff";
    ctx.shadowColor = "black";
    ctx.shadowBlur = 8;
    wrapText(ctx, text, r - 36, 0, 150, 18);
    ctx.restore();
  });

  // center hub
  ctx.beginPath();
  ctx.arc(cx, cy, 70, 0, Math.PI * 2);
  ctx.fillStyle = "rgba(0,0,0,0.6)";
  ctx.fill();
  ctx.strokeStyle = "white";
  ctx.lineWidth = 3;
  ctx.stroke();

  ctx.fillStyle = "white";
  ctx.font = "900 22px Arial";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.shadowBlur = 0;
  ctx.fillText("SPIN", cx, cy);
}

drawWheel();

/* ================= SPIN ================= */
function spin(user, amount) {
  if (spinning) return;
  spinning = true;

  playSound(soundSpin);

  panel.classList.remove("flash");
  void panel.offsetWidth;
  panel.classList.add("flash");

  lastTip.textContent = `Tip ${amount} by ${user}`;

  const spins = 7 + Math.random() * 3;
  const final = angle + spins * Math.PI * 2 + Math.random() * Math.PI * 2;
  const startTime = performance.now();
  const duration = 5200;

  function ease(t){ return 1 - Math.pow(1 - t, 3); }

  function frame(now){
    const t = Math.min(1,(now-startTime)/duration);
    angle += (final-angle)*ease(t);
    drawWheel();
    if(t < 1) requestAnimationFrame(frame);
    else{
      const index = Math.floor(
        ((Math.PI*1.5 - angle + Math.PI*2)%(Math.PI*2)) /
        ((Math.PI*2)/ITEMS.length)
      );
      lastResult.textContent = ITEMS[index];
      playSound(soundWin);
      spinning = false;
    }
  }
  requestAnimationFrame(frame);
}

/* ================= TIP HANDLING ================= */
function handleTip(data){
  if(!data || data.type !== "tip") return;

  playSound(soundTip);

  const user = data.user || "anon";
  const amount = Number(data.amount || 0);

  if(amount >= SPIN_COST){
    spin(user, amount);
  } else {
    lastTip.textContent = `Tip ${amount} by ${user}`;
  }
}

// postMessage support
window.addEventListener("message", e => handleTip(e.data));

// BroadcastChannel (Dev Portal → OBS)
try{
  const bc = new BroadcastChannel("cb-overlays");
  bc.onmessage = e => handleTip(e.data);
}catch(e){}
</script>

</body>
</html>
